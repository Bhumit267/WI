datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Operator {
  id             String          @id @default(uuid())
  name           String          @unique
  trustScore     Float           @default(100.0)
  complaintCount Int             @default(0)
  avgRefundTime  Int             @default(0) // in hours
  tickets        Ticket[]
  complaints     Complaint[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  trustScoreLogs TrustScoreLog[]
}

model Ticket {
  id                 String      @id @default(uuid())
  pnr                String      @unique
  operatorId         String
  operator           Operator    @relation(fields: [operatorId], references: [id])
  status             String // BOOKED, CANCELLED
  refundAmount       Float?
  refundDeadline     DateTime?
  cancellationPolicy String // JSON string or description
  refunds            Refund[]
  complaints         Complaint[]
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
}

model Refund {
  id          String    @id @default(uuid())
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id])
  status      String // INITIATED, COMPLETED
  amount      Float
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model User {
  id         String      @id @default(uuid())
  email      String      @unique
  password   String
  role       String // ADMIN, USER
  name       String?
  complaints Complaint[]
  messages   Message[]
  auditLogs  AuditLog[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model AuditLog {
  id            String   @id @default(uuid())
  action        String // E.g., "RESOLVE_COMPLAINT"
  targetId      String // ID of the object (Complaint/Operator)
  details       String
  justification String? // Required for sensitive actions
  performedBy   String
  user          User     @relation(fields: [performedBy], references: [id])
  createdAt     DateTime @default(now())
}

model TrustScoreLog {
  id         String   @id @default(uuid())
  operatorId String
  operator   Operator @relation(fields: [operatorId], references: [id])
  oldScore   Float
  newScore   Float
  reason     String // "SLA Violation", "Complaint Escalation"
  createdAt  DateTime @default(now())
}

model SLAConfig {
  id        String   @id @default(uuid())
  type      String // "REFUND_TIMEOUT", "COMPLAINT_RESPONSE"
  threshold Int // Hours, e.g., 48
  penalty   Float // Trust score deduction, e.g., 0.5
  updatedAt DateTime @updatedAt
}

model Complaint {
  id         String    @id @default(uuid())
  pnr        String
  ticket     Ticket    @relation(fields: [pnr], references: [pnr])
  operatorId String
  operator   Operator  @relation(fields: [operatorId], references: [id])
  userId     String?
  user       User?     @relation(fields: [userId], references: [id])
  reason     String
  status     String // PENDING, OPEN, RESOLVED, ESCALATED
  messages   Message[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Message {
  id          String    @id @default(uuid())
  complaintId String
  complaint   Complaint @relation(fields: [complaintId], references: [id])
  senderId    String
  sender      User      @relation(fields: [senderId], references: [id])
  content     String
  read        Boolean   @default(false)
  createdAt   DateTime  @default(now())
}
